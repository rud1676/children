import Database from 'better-sqlite3';
import path from 'path';
import bcrypt from 'bcryptjs';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// 데이터베이스 파일 경로
const dbPath = path.join(process.cwd(), 'student_praise.db');
const db = new Database(dbPath);

// 데이터베이스 초기화
function initDatabase() {
  // 사용자 테이블 생성
  db.exec(`
    CREATE TABLE IF NOT EXISTS users (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      phone_number TEXT UNIQUE NOT NULL,
      name TEXT NOT NULL,
      password TEXT,
      role TEXT NOT NULL CHECK (role IN ('student', 'teacher')),
      is_first_login BOOLEAN DEFAULT TRUE,
      
      -- 학생 전용 정보
      school TEXT,
      grade INTEGER,
      class_number INTEGER,
      student_number INTEGER,
      
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);

  // 칭찬 테이블 생성
  db.exec(`
    CREATE TABLE IF NOT EXISTS praises (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      from_user_id INTEGER NOT NULL,
      to_user_id INTEGER NOT NULL,
      content TEXT NOT NULL,
      is_selected BOOLEAN DEFAULT FALSE,
      is_deleted BOOLEAN DEFAULT FALSE,
      deleted_by INTEGER,
      delete_reason TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (from_user_id) REFERENCES users(id),
      FOREIGN KEY (to_user_id) REFERENCES users(id),
      FOREIGN KEY (deleted_by) REFERENCES users(id)
    )
  `);

  // 알림 테이블 생성
  db.exec(`
    CREATE TABLE IF NOT EXISTS notifications (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      user_id INTEGER NOT NULL,
      type TEXT NOT NULL,
      message TEXT NOT NULL,
      is_read BOOLEAN DEFAULT FALSE,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (user_id) REFERENCES users(id)
    )
  `);

  console.log('데이터베이스 초기화 완료');
}

// 샘플 데이터 삽입 (개발용)
function insertSampleData() {
  const insertUser = db.prepare(`
    INSERT OR IGNORE INTO users (phone_number, name, role, school, grade, class_number, student_number)
    VALUES (?, ?, ?, ?, ?, ?, ?)
  `);

  // 학생 데이터 (고3)
  const students = [
    ['01053873362', '경건', 'student', '도농고등학교', 3, null, null],
    ['01039534788', '양승철', 'student', '도농고등학교', 3, null, null],
    ['01037735323', '김찬솔', 'student', '동화고등학교', 3, null, null],
    ['01064732420', '안이찬', 'student', '가운중학교', 3, null, null],

    // 고2
    ['01041234221', '강준혁', 'student', '도농고등학교', 2, null, null],
    ['01021730173', '임수아', 'student', '도농고등학교', 2, null, null],
    ['01047375309', '장윤성', 'student', '도농고등학교', 2, null, null],
    ['01062932809', '정시은', 'student', '도농고등학교', 2, null, null],
    ['01027315812', '이규연', 'student', '도농고등학교', 2, null, null],
    ['01099544003', '김상훈', 'student', '도농고등학교', 2, null, null],
    ['01000000000', '서하영', 'student', '도농고등학교', 2, null, null],

    // 고1
    ['01076134766', '송제니', 'student', '교문중학교', 1, null, null],
    ['01000000001', '정다솜', 'student', '도농고등학교', 1, null, null],
    ['01093089386', '전혜인', 'student', '오남중학교', 1, null, null],
    ['01080621022', '김단우', 'student', '다산한강중학교', 1, null, null],
    ['01055227145', '이민지', 'student', '도농고등학교', 1, null, null],
    ['01000000002', '조예령', 'student', '도농고등학교', 1, null, null],

    // 중3
    ['01096207292', '권율', 'student', '다산중학교', 3, null, null],
    ['01032048785', '이태연', 'student', '인창중학교', 3, null, null],
    ['01084274788', '양승규', 'student', '동화중학교', 3, null, null],
    ['01099772809', '정주원', 'student', '인창중학교', 3, null, null],
    ['01046793362', '경하영', 'student', '가운중학교', 3, null, null],
    ['01021299669', '허윤재', 'student', '동화중학교', 3, null, null],
    ['01049043626', '김지환', 'student', '동화중학교', 3, null, null],
    ['01031156740', '곽용태', 'student', '다산중학교', 3, null, null],
    ['01046741602', '서태웅', 'student', '다산중학교', 3, null, null],
    ['01000000003', '안하선', 'student', '도농중학교', 3, null, null],
    ['01090763845', '원은석', 'student', '동화중학교', 3, null, null],

    // 중2
    ['01075420844', '배성현', 'student', '도농중학교', 2, null, null],
    ['01082734766', '송혜니', 'student', '도농중학교', 2, null, null],
    ['01098787251', '이하랑', 'student', '도농중학교', 2, null, null],
    ['01094367885', '서주아', 'student', '도농중학교', 2, null, null],
    ['01096237292', '권담의', 'student', '도농중학교', 2, null, null],
    ['01075466537', '문주희', 'student', '도농중학교', 2, null, null],
    ['01065478990', '김산', 'student', '도농중학교', 2, null, null],
    ['01092486585', '김주하', 'student', '도농중학교', 2, null, null],
    ['01091256542', '유이', 'student', '도농중학교', 2, null, null],
  ];

  students.forEach((student) => {
    insertUser.run(student);
  });

  // 선생님 데이터
  const teachers = [
    ['01012344321', '관리자', 'teacher'],
    ['01084412248', '오현준', 'teacher'],
    ['01032341334', '나리', 'teacher'],
    ['01047342088', '원인숙', 'teacher'],
    ['01087310534', '임대현', 'teacher'],
    ['01042405264', '이성봉', 'teacher'],
    ['01000000004', '신한나', 'teacher'],
    ['01049609603', '주경진', 'teacher'],
    ['01072209917', '윤지성', 'teacher'],
    ['01041302088', '장서영', 'teacher'],
    ['01028346025', '권빈', 'teacher'],
  ];

  teachers.forEach((teacher) => {
    insertUser.run([
      teacher[0],
      teacher[1],
      teacher[2],
      null,
      null,
      null,
      null,
    ]);
  });

  // 칭찬 데이터 삽입
  const insertPraise = db.prepare(`
    INSERT OR IGNORE INTO praises (from_user_id, to_user_id, content, is_selected)
    VALUES (?, ?, ?, ?)
  `);

  // 테스트 칭찬 데이터 (몇 명 학생들에게만)
  const praises = [
    // 경건에게 받은 칭찬들 (8개 + 추가)
    [2, 1, '경건이는 항상 찬양할 때 열심히 참여해주고 있어서 정말 감사해!', 1],
    [3, 1, '경건이의 섬김하는 마음이 정말 아름다워', 1],
    [4, 1, '경건이가 찬양팀에서 하는 모습이 너무 멋져', 1],
    [5, 1, '경건이는 항상 다른 사람을 먼저 생각하는 마음이 있어', 0],
    [6, 1, '경건이의 리더십이 정말 대단해', 1],
    [7, 1, '경건이는 항상 예의 바르고 매너가 좋아', 0],
    [8, 1, '경건이의 긍정적인 마인드가 정말 좋아', 1],
    [9, 1, '경건이는 항상 웃음이 많아서 주변 사람들도 행복해져', 0],
    [10, 1, '경건이는 친구들을 잘 챙겨주는 따뜻한 리더야', 0],
    [11, 1, '경건이 덕분에 모두가 힘을 얻어요!', 0],
    [12, 1, '경건이는 항상 밝은 미소로 인사해줘서 기분이 좋아져', 0],

    // 양승철에게 받은 칭찬들 (3개 + 추가)
    [1, 2, '승철이는 항상 밝은 에너지로 분위기를 밝게 만들어줘', 1],
    [3, 2, '승철이의 긍정적인 마인드가 정말 좋아', 0],
    [4, 2, '승철이는 항상 웃음이 많아서 주변 사람들도 행복해져', 1],
    [5, 2, '승철이는 어려운 상황에서도 포기하지 않아 멋져', 1],
    [6, 2, '승철이는 친구들에게 힘이 되는 존재야', 0],
    [7, 2, '승철이는 항상 솔선수범하는 모습이 인상적이야', 1],

    // 김찬솔에게 받은 칭찬들 (2개 + 추가)
    [1, 3, '찬솔이는 항상 진지하게 말씀을 듣는 모습이 인상적이야', 0],
    [2, 3, '찬솔이의 성실함이 정말 대단해', 1],
    [4, 3, '찬솔이는 친구들을 잘 도와주는 따뜻한 마음이 있어', 1],
    [5, 3, '찬솔이는 항상 예의 바르고 배려심이 깊어', 0],
    [6, 3, '찬솔이는 힘든 일도 묵묵히 해내는 멋진 친구야', 1],

    // 안이찬에게 받은 칭찬들 (3개 + 추가)
    [1, 4, '이찬이는 항상 도움이 필요할 때 먼저 나서주는 마음이 있어', 1],
    [2, 4, '이찬이의 섬김하는 마음이 정말 아름다워', 0],
    [3, 4, '이찬이는 항상 겸손하고 예의 바른 모습이 보기 좋아', 1],
    [5, 4, '이찬이는 친구들에게 용기를 주는 멋진 친구야', 1],
    [6, 4, '이찬이는 항상 밝은 에너지로 모두를 웃게 해줘', 0],

    // 강준혁에게 받은 칭찬들 (2개 + 추가)
    [6, 5, '준혁이는 회장으로서 정말 책임감 있게 일해주고 있어', 1],
    [7, 5, '준혁이의 리더십이 정말 대단해', 0],
    [8, 5, '준혁이는 항상 친구들을 배려하는 따뜻한 마음이 있어', 1],
    [9, 5, '준혁이는 힘든 일도 웃으면서 해내는 멋진 친구야', 1],

    // 임수아에게 받은 칭찬들 (2개 + 추가)
    [5, 6, '수아는 부회장으로서 정말 열심히 일해주고 있어', 1],
    [7, 6, '수아의 섬김하는 마음이 정말 아름다워', 0],
    [8, 6, '수아는 항상 밝은 미소로 모두를 기분 좋게 해줘', 1],
    [9, 6, '수아는 친구들에게 힘이 되는 존재야', 1],

    // 칭찬 데이터가 없던 학생들 추가 (서하영: 11, 정다솜: 13, 전혜인: 14, 김상훈: 10, 조예령: 17)
    [1, 11, '하영이는 항상 밝은 미소로 모두를 기분 좋게 해줘요!', 1],
    [2, 11, '하영이는 친구들을 잘 챙겨주는 따뜻한 마음이 있어요.', 0],
    [3, 11, '하영이는 힘든 일도 웃으면서 해내는 멋진 친구예요.', 1],

    [4, 13, '다솜이는 항상 예의 바르고 배려심이 깊어요.', 1],
    [5, 13, '다솜이는 친구들에게 힘이 되는 존재예요.', 0],
    [6, 13, '다솜이는 밝은 에너지로 모두를 웃게 해줘요.', 1],

    [7, 14, '혜인은 항상 진지하게 말씀을 듣는 모습이 인상적이에요.', 1],
    [8, 14, '혜인은 친구들을 잘 도와주는 따뜻한 마음이 있어요.', 0],
    [9, 14, '혜인은 항상 솔선수범하는 모습이 멋져요.', 1],

    [10, 10, '상훈이는 항상 긍정적인 마인드로 주변을 밝게 해줘요.', 1],
    [11, 10, '상훈이는 친구들에게 용기를 주는 멋진 친구예요.', 0],
    [12, 10, '상훈이는 힘든 일도 묵묵히 해내는 모습이 멋져요.', 1],

    [13, 17, '예령이는 항상 밝은 미소로 인사해줘서 기분이 좋아져요.', 1],
    [14, 17, '예령이는 친구들을 잘 챙겨주는 따뜻한 리더예요.', 0],
    [15, 17, '예령이는 모두가 힘을 얻는 에너지원이에요.', 1],

    // 추가 학생들 (김주하: 28, 서주아: 27, 이하랑: 26, 문주희: 25, 김산: 24, 배성현: 18, 송혜니: 19, 권담의: 22, 곽용태: 31, 서태웅: 32, 안하선: 33, 원은석: 34)
    [2, 28, '주하는 항상 친구들을 도와주는 따뜻한 마음이 있어요.', 1],
    [3, 28, '주하는 밝은 에너지로 모두를 웃게 해줘요.', 0],
    [4, 28, '주하는 힘든 일도 묵묵히 해내는 멋진 친구예요.', 1],
    [5, 28, '주하는 언제나 솔선수범하는 모습이 멋져요.', 1],
    [6, 28, '주하는 모두에게 긍정적인 영향을 주는 친구예요.', 0],

    [5, 27, '주아는 항상 예의 바르고 배려심이 깊어요.', 1],
    [6, 27, '주아는 친구들에게 힘이 되는 존재예요.', 0],
    [7, 27, '주아는 밝은 미소로 모두를 기분 좋게 해줘요.', 1],
    [8, 27, '주아는 힘든 일도 웃으면서 해내는 멋진 친구예요.', 1],
    [9, 27, '주아는 친구들을 잘 챙겨주는 따뜻한 리더예요.', 0],

    [8, 26, '하랑이는 항상 진지하게 말씀을 듣는 모습이 인상적이에요.', 1],
    [9, 26, '하랑이는 친구들을 잘 도와주는 따뜻한 마음이 있어요.', 0],
    [10, 26, '하랑이는 항상 솔선수범하는 모습이 멋져요.', 1],
    [11, 26, '하랑이는 모두가 힘을 얻는 에너지원이에요.', 1],
    [12, 26, '하랑이는 항상 긍정적인 마인드로 주변을 밝게 해줘요.', 0],

    [11, 25, '주희는 항상 긍정적인 마인드로 주변을 밝게 해줘요.', 1],
    [12, 25, '주희는 친구들에게 용기를 주는 멋진 친구예요.', 0],
    [13, 25, '주희는 힘든 일도 묵묵히 해내는 모습이 멋져요.', 1],
    [14, 25, '주희는 항상 밝은 미소로 인사해줘서 기분이 좋아져요.', 1],
    [15, 25, '주희는 친구들에게 힘이 되는 존재예요.', 0],

    [14, 24, '산이는 항상 밝은 미소로 인사해줘서 기분이 좋아져요.', 1],
    [15, 24, '산이는 친구들을 잘 챙겨주는 따뜻한 리더예요.', 0],
    [16, 24, '산이는 모두가 힘을 얻는 에너지원이에요.', 1],
    [17, 24, '산이는 언제나 솔선수범하는 모습이 멋져요.', 1],
    [18, 24, '산이는 밝은 에너지로 모두를 웃게 해줘요.', 0],

    [17, 18, '성현이는 항상 밝은 에너지로 분위기를 밝게 만들어줘요.', 1],
    [1, 18, '성현이는 친구들에게 힘이 되는 존재예요.', 0],
    [2, 18, '성현이는 항상 솔선수범하는 모습이 멋져요.', 1],
    [3, 18, '성현이는 모두에게 긍정적인 영향을 주는 친구예요.', 1],
    [4, 18, '성현이는 힘든 일도 웃으면서 해내는 멋진 친구예요.', 0],

    [3, 19, '혜니는 항상 진지하게 말씀을 듣는 모습이 인상적이에요.', 1],
    [4, 19, '혜니는 친구들을 잘 도와주는 따뜻한 마음이 있어요.', 0],
    [5, 19, '혜니는 항상 예의 바르고 배려심이 깊어요.', 1],
    [6, 19, '혜니는 모두가 힘을 얻는 에너지원이에요.', 1],
    [7, 19, '혜니는 밝은 미소로 모두를 기분 좋게 해줘요.', 0],

    [6, 22, '담의는 항상 긍정적인 마인드로 주변을 밝게 해줘요.', 1],
    [7, 22, '담의는 친구들에게 용기를 주는 멋진 친구예요.', 0],
    [8, 22, '담의는 힘든 일도 묵묵히 해내는 모습이 멋져요.', 1],
    [9, 22, '담의는 언제나 솔선수범하는 모습이 멋져요.', 1],
    [10, 22, '담의는 모두에게 긍정적인 영향을 주는 친구예요.', 0],

    [9, 31, '용태는 항상 밝은 미소로 인사해줘서 기분이 좋아져요.', 1],
    [10, 31, '용태는 친구들을 잘 챙겨주는 따뜻한 리더예요.', 0],
    [11, 31, '용태는 모두가 힘을 얻는 에너지원이에요.', 1],
    [12, 31, '용태는 힘든 일도 묵묵히 해내는 멋진 친구예요.', 1],
    [13, 31, '용태는 밝은 에너지로 모두를 웃게 해줘요.', 0],

    [12, 32, '태웅이는 항상 밝은 에너지로 분위기를 밝게 만들어줘요.', 1],
    [13, 32, '태웅이는 친구들에게 힘이 되는 존재예요.', 0],
    [14, 32, '태웅이는 항상 솔선수범하는 모습이 멋져요.', 1],
    [15, 32, '태웅이는 모두가 힘을 얻는 에너지원이에요.', 1],
    [16, 32, '태웅이는 밝은 미소로 모두를 기분 좋게 해줘요.', 0],

    [15, 33, '하선이는 항상 진지하게 말씀을 듣는 모습이 인상적이에요.', 1],
    [16, 33, '하선이는 친구들을 잘 도와주는 따뜻한 마음이 있어요.', 0],
    [17, 33, '하선이는 항상 예의 바르고 배려심이 깊어요.', 1],
    [18, 33, '하선이는 모두에게 긍정적인 영향을 주는 친구예요.', 1],
    [19, 33, '하선이는 힘든 일도 웃으면서 해내는 멋진 친구예요.', 0],

    [18, 34, '은석이는 항상 긍정적인 마인드로 주변을 밝게 해줘요.', 1],
    [1, 34, '은석이는 친구들에게 용기를 주는 멋진 친구예요.', 0],
    [2, 34, '은석이는 힘든 일도 묵묵히 해내는 모습이 멋져요.', 1],
    [3, 34, '은석이는 밝은 미소로 모두를 기분 좋게 해줘요.', 1],
    [4, 34, '은석이는 친구들에게 잘 챙겨주는 따뜻한 리더예요.', 0],
  ];

  praises.forEach((praise) => {
    insertPraise.run(praise);
  });

  console.log('샘플 데이터 삽입 완료');
}

// 데이터베이스 초기화 실행
// initDatabase();
// insertSampleData();

// 데이터베이스 초기화와 샘플 데이터 삽입 함수만 export (직접 실행 X)
export { db, bcrypt, initDatabase, insertSampleData };
